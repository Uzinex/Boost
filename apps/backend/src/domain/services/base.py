"""
Uzinex Boost ‚Äî Base Service
===========================

–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö –±–∏–∑–Ω–µ—Å-—Å–µ—Ä–≤–∏—Å–æ–≤ Uzinex Boost v2.0.

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
-----------
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤:
- –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–µ—Å—Å–∏–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤;
- —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ;
- –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –∏ –æ—à–∏–±–æ–∫;
- –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –¥–æ–º–µ–Ω–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ (`domain.rules`);
- —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Å–æ–±—ã—Ç–∏—è–º–∏ (`domain.events`).

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–ª–∞—Å—Å –¥–ª—è:
- UserService
- BalanceService
- PaymentService
- OrderService
- TaskService
- ReferralService
"""

from __future__ import annotations
from typing import Any, Optional
from sqlalchemy.ext.asyncio import AsyncSession
from loguru import logger

from domain.events.dispatcher import EventDispatcher


# -------------------------------------------------
# üîπ –ë–∞–∑–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å
# -------------------------------------------------
class BaseService:
    """
    –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å–∏—Å—Ç–µ–º—ã.

    –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç:
    - –¥–æ—Å—Ç—É–ø –∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Å–µ—Å—Å–∏–∏ SQLAlchemy;
    - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ª–æ–≥–≥–µ—Ä;
    - –º–µ—Ç–æ–¥—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π;
    - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫.
    """

    def __init__(self, session: AsyncSession):
        self.session = session
        self.logger = logger.bind(service=self.__class__.__name__)

    # -------------------------------------------------
    # üî∏ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
    # -------------------------------------------------
    async def log(self, message: str, **kwargs: Any):
        """
        –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π —Å–µ—Ä–≤–∏—Å–∞.
        """
        self.logger.info(f"{self.__class__.__name__}: {message}", **kwargs)

    # -------------------------------------------------
    # üî∏ –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
    # -------------------------------------------------
    async def publish_event(self, event: Any):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–º–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ —à–∏–Ω—É —Å–æ–±—ã—Ç–∏–π (Event Bus).
        """
        await EventDispatcher.publish(event)
        self.logger.debug(f"Event published: {event.event_type} ({event.__class__.__name__})")

    # -------------------------------------------------
    # üî∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    # -------------------------------------------------
    async def safe_execute(self, func, *args, **kwargs) -> Optional[Any]:
        """
        –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ—Ç–ª–æ–≤–æ–º –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ.
        """
        try:
            result = await func(*args, **kwargs)
            return result
        except Exception as e:
            self.logger.exception(f"Error in {self.__class__.__name__}: {e}")
            await self.session.rollback()
            return None

    # -------------------------------------------------
    # üî∏ –ö–æ–º–º–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    # -------------------------------------------------
    async def commit(self):
        """
        –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏.
        """
        try:
            await self.session.commit()
            self.logger.debug("Session committed successfully.")
        except Exception as e:
            self.logger.exception(f"Commit failed: {e}")
            await self.session.rollback()

    # -------------------------------------------------
    # üî∏ –û—Ç–∫–∞—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    # -------------------------------------------------
    async def rollback(self):
        """
        –û—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
        """
        await self.session.rollback()
        self.logger.warning("Session rolled back.")
