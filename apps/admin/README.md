# Uzinex Boost — Admin (Docs & Ops)

> **Решение по архитектуре:** отдельного SPA для админки **не будет**. Админ-интерфейс встроен в Telegram WebApp и располагается в `apps/webapp/public/admin.html`.  
> Каталог `apps/admin` — это **операционная документация, чек-листы, коллекции API и служебные скрипты**.

---

## Задача админ-части
- Подтверждение пополнений (чеки)  
- Обработка заявок/заданий: `submitted → approved/rejected`  
- Управление заказами: `draft/active/paused/completed/cancelled`  
- Пользователи: бан/разбан, просмотр статуса и баланса  
- Аудит действий админов

---

## Где находится UI
- **UI:** `apps/webapp/public/admin.html`
- **Стили/скрипты:** `apps/webapp/src/js/{tasks.js,orders.js,api.js,sdk.js}`, `apps/webapp/src/css/styles.css`
- **Бэкенд:** `apps/backend/src/api/v1/*` (см. эндпоинты ниже)

---

## Быстрый старт (локально)
1. Запусти стек: `docker compose up -d`  
2. Открой WebApp URL (см. `WEBAPP_URL` в `.env`) → авторизуйся как админ.  
3. Перейди на `/admin.html` (через кнопку в боте или напрямую при отладке).

> Чтобы аккаунт стал админом: в БД у пользователя `role = 'admin'`.

---

## Эндпоинты, используемые админ-UI (v1)
- **Deposits**
  - `GET /api/v1/admin/deposits?status=pending` — список чеков на модерации  
  - `POST /api/v1/deposits/{id}/approve` — подтверждение  
  - `POST /api/v1/deposits/{id}/reject` — отклонение
- **Tasks**
  - `GET /api/v1/admin/tasks?state=submitted` — ожидание проверки  
  - `POST /api/v1/tasks/{id}/approve` — зачесть и начислить  
  - `POST /api/v1/tasks/{id}/reject` — отклонить с причиной
- **Orders**
  - `GET /api/v1/admin/orders?status=active|paused|...`  
  - `PATCH /api/v1/orders/{id}` — смена статуса/параметров (допустимые поля ограничены)
- **Users**
  - `GET /api/v1/admin/users?query=` — поиск  
  - `POST /api/v1/admin/users/{id}/ban` / `unban`
- **Tech**
  - `GET /api/v1/healthz`

> Авторизация: серверная валидация `Telegram WebApp initData`. Для админ-вью бэкенд проверяет `role='admin'`.

---

## Матрица ролей (сокращённо)

| Действие                       | user | admin |
|--------------------------------|:----:|:-----:|
| Просмотр своих депозитов       |  ✅  |  ✅   |
| Просмотр pending депозитов     |  ❌  |  ✅   |
| Approve/Reject депозит         |  ❌  |  ✅   |
| Просмотр своих задач           |  ✅  |  ✅   |
| Модерация задач (approve/reject)| ❌  |  ✅   |
| Создание/управление заказами   |  ✅  |  ✅   |
| Бан/разбан пользователя        |  ❌  |  ✅   |
| Просмотр аудита                |  ❌  |  ✅   |

---

## Политики модерации (минимум)
- **Deposits:** сверка суммы/времени, корректность реквизитов, отсутствие дублей (`idempotency_key`).  
- **Tasks:** проверка факта подписки/вступления (по возможности `getChatMember`), античит-правила (мгновенный лив, массовые отписки).  
- **Orders:** запрет менять поля, влияющие на уже выданные задания (кроме паузы/возобновления).

---

## Безопасность
- Проверка `initData` (HMAC-SHA256 + `auth_date` TTL).  
- `role` и `status` проверяются на каждом админ-запросе.  
- Все админ-мутации логируются в `boost_audit_logs`.  
- Для опасных операций — заголовок `Idempotency-Key`.

---

## UX-потоки (admin.html)
- **Deposits:** список → модалка карточки → `Approve/Reject (+reason)` → тост-уведомление.  
- **Tasks:** очередь → предпросмотр пруфа → `Approve/Reject` → автоначисление UZT.  
- **Orders:** таблица активных → `Pause/Resume/Complete`.  
- **Users:** поиск → карточка → `Ban/Unban`.

---

## Переменные окружения (важные)
- `WEBAPP_URL` — базовый URL WebApp (кнопка в боте)  
- `BACKEND_BASE_URL` — корень API, который дергает админ-UI  
- `TELEGRAM_BOT_TOKEN_FOR_HASH` — токен для валидации `initData`  
- `ADMIN_LOGIN_BYPASS=false` — **только для dev**, отключает Telegram-поток (если нужно)

---

## Тест-чеклист перед релизом
- [ ] Роль `admin` назначается и читается из JWT/сессии initData  
- [ ] Список `pending` депозитов показывается, пагинация работает  
- [ ] `Approve/Reject` возвращают корректные статусы и создают транзакции  
- [ ] Очередь задач `submitted` отображается, пруфы доступны  
- [ ] `Approve` задачи → корректное начисление на кошелёк  
- [ ] `Reject` задачи → причина логируется, средства не начисляются  
- [ ] `Pause/Resume` заказа обновляет выдачу задач  
- [ ] Логи `audit` создаются на каждую админ-мутацию  
- [ ] Rate-limit на админ-эндпоинты соблюдается  
- [ ] CORS/headers корректны для WebApp в Telegram

---

## Артефакты в этом каталоге
- `postman/collection.json` — коллекция запросов (добавим при появлении эндпоинтов)
- `scripts/` — вспомогательные скрипты (сид администратора, очистка очередей)
- `playbooks/` — процедурные инструкции на инциденты и релизы

---

## План дальнейших улучшений
- Фильтры и массовые операции в очередях (bulk approve)  
- Экспорт CSV для депозитов/транзакций  
- Гранулярные роли (`moderator`, `finance_admin`) при необходимости  
- Встроенная метрика действий (гистограммы по дням)

